<script setup lang="ts">
import { useMutation } from "@tanstack/vue-query";
import { postLogin } from "~/services/auth";
import { setTokens } from "~/utils/token";

const router = useRouter();
const pinNumber = ref<string[]>([]); // PIN 번호를 저장하는 배열
const toast = useToast(); // 토스트 알림을 위한 훅

const { mutate: postLoginApi } = useMutation({
  mutationKey: ["login", pinNumber.value.join("")],
  mutationFn: async () => {
    const response = await postLogin({
      username: pinNumber.value.join(""),
      password: pinNumber.value.join(""),
    });
    // 여기에 로그인 API 호출 로직을 추가할 수 있습니다.
    // 예시로, 토큰을 설정하는 함수를 호출합니다.
    return response.data;
  },
  onSuccess: (res) => {
    setTokens({ accessToken: res.accessToken, refreshToken: res.refreshToken });
    router.replace("/"); // 로그인 성공 후 홈으로 리다이렉트
  },
  onError: (error) => {
    console.error("로그인 실패:", error);
    pinNumber.value = []; // PIN 번호 초기화
    // 로그인 실패 시 사용자에게 알림을 표시하거나 다른 처리를 할 수 있습니다.
    toast.add({
      title: "로그인 실패",
      description: "비밀번호가 올바르지 않습니다. 다시 시도해주세요.",
      color: "error",
      duration: 3000,
    });
  },
});

const onClickPinButton = (number: number) => {
  if (pinNumber.value.length < 6) {
    pinNumber.value.push(number === 10 ? "0" : number.toString());
  }
};

const onClickBackspace = () => {
  if (pinNumber.value.length > 0) {
    pinNumber.value.pop();
  }
};

const onClickConfirm = () => {
  postLoginApi();
};

defineExpose({ pinNumber }); // 🔑 테스트를 위한 노출
</script>

<template>
  <div class="max-w-md mx-auto">
    <main class="px-6">
      <div class="w-10 mt-20 mx-auto">
        <NuxtImg src="assets/images/logos/symbol-logo.png" alt="kb_logo" />
      </div>

      <KBUITypography
        tag="h2"
        size="h24"
        weight="bold"
        class-name="mt-4 text-center"
        color="white"
      >
        KB국민인증서
      </KBUITypography>
      <UPinInput
        v-model="pinNumber"
        aria-readonly
        mask
        :length="6"
        class="mt-20 justify-center w-full"
      />
      <div
        class="fixed bottom-0 left-1/2 bg-gray-5 py-5 px-6 grid grid-cols-4 gap-2 max-w-md transform -translate-x-1/2 w-full"
      >
        <KBUIButton
          v-for="i in 10"
          :key="i"
          :class-name="i === 2 ? 'col-start-4' : ''"
          size="medium"
          variant="outlined"
          @click="onClickPinButton(i)"
          >{{ i === 10 ? "0" : i }}</KBUIButton
        >
        <KBUIButton variant="secondary" size="medium" @click="onClickBackspace">
          <UIcon name="material-symbols-light:backspace" size="24" />
        </KBUIButton>
        <KBUIButton variant="ghost" size="medium"> 취소 </KBUIButton>
        <KBUIButton
          variant="primary"
          size="medium"
          class-name="w-full col-span-2 block"
          :disabled="pinNumber.length < 6 ? true : false"
          @click="onClickConfirm"
        >
          확인
        </KBUIButton>
      </div>
    </main>
  </div>
</template>
